<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deal or No Deal - 16 Case Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --case-size: min(30vw, 200px); /* A3 giant case size */
      --case-border-radius: 10px;
      --bg-gradient: radial-gradient(circle at top, #222 0%, #050505 55%, #000 100%);
      --primary-gold: #ffcc00;
      --primary-gold-soft: rgba(255, 204, 0, 0.4);
      --accent-blue: #1e88e5;
      --text-main: #f5f5f5;
      --text-muted: #bbb;
      --danger: #ff5252;
      --success: #4caf50;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .page-wrapper {
      width: 100%;
      max-width: 1200px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      text-align: center;
      padding: 8px 0 4px;
    }

    header h1 {
      font-size: clamp(1.6rem, 3vw, 2.4rem);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--primary-gold);
      text-shadow: 0 0 16px rgba(0, 0, 0, 0.6);
    }

    header p {
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(15, 15, 15, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
    }

    .status-text {
      font-size: clamp(1rem, 2.2vw, 1.3rem);
      font-weight: 600;
      color: var(--primary-gold);
    }

    .round-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .round-info span {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.6));
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Left: grid section */
    .grid-section {
      background: rgba(10, 10, 10, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.75);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .grid-title {
      font-size: 0.95rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .case-grid {
      display: grid;
      gap: 10px;
      justify-items: center;
    }

    /* Grid responsiveness (S2) */
    @media (min-width: 1025px) {
      .case-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }
    }

    @media (max-width: 1024px) and (min-width: 768px) {
      .case-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (max-width: 767px) and (min-width: 480px) {
      .case-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 479px) {
      .case-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .case {
      position: relative;
      width: var(--case-size);
      max-width: 200px;
      aspect-ratio: 4 / 3;
      border-radius: var(--case-border-radius);
      overflow: hidden;
      background: linear-gradient(to bottom, #444, #111);
      border: 2px solid rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.7);
    }

    .case img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      pointer-events: none;
    }

    .case-number {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.75);
      color: var(--primary-gold);
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .case.revealed {
      cursor: default;
      filter: grayscale(0.9) brightness(0.6);
      box-shadow: none;
    }

    .case.disabled {
      pointer-events: none;
      opacity: 0.8;
    }

    /* Hover animation only in selection phase (H4 + B) */
    .selection-phase .case:hover:not(.revealed):not(.disabled) {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 0 0 25px rgba(255, 204, 0, 0.6);
      filter: brightness(1.15);
    }

    /* Right: main case + values */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-case-wrapper {
      background: radial-gradient(circle at top, rgba(255, 204, 0, 0.3), rgba(0, 0, 0, 0.95));
      border-radius: 14px;
      padding: 12px 10px 16px;
      border: 1px solid rgba(255, 204, 0, 0.5);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .main-case-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .main-case-slot {
      width: calc(var(--case-size) * 1.1); /* M2 scaling: slightly smaller than grid cases */
      max-width: 280px;
      aspect-ratio: 4 / 3;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--case-border-radius);
      background: rgba(0, 0, 0, 0.85);
      border: 2px dashed rgba(255, 255, 255, 0.16);
      overflow: hidden;
      position: relative;
    }

    .main-case-slot .case {
      width: 100%;
      max-width: none;
      box-shadow: none;
      border: none;
    }

    .no-main-case-placeholder {
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 0 8px;
    }

    .main-case-number-tag {
      position: absolute;
      top: 6px;
      right: 8px;
      padding: 3px 9px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 999px;
      color: var(--primary-gold);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.06em;
    }

    .values-panel {
      background: rgba(6, 6, 6, 0.95);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 10px 10px 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.75);
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 8px;
      font-size: 0.9rem;
    }

    .value-item {
      padding: 3px 8px;
      border-radius: 999px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to right, rgba(255, 255, 255, 0.04), rgba(0, 0, 0, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: var(--text-main);
    }

    .value-item.low {
      border-color: rgba(255, 255, 255, 0.2);
    }

    .value-item.high {
      border-color: var(--primary-gold-soft);
      background: linear-gradient(to right, rgba(255, 204, 0, 0.06), rgba(0, 0, 0, 0.9));
    }

    .value-item.opened {
      text-decoration: line-through;
      opacity: 0.35;
    }

    .value-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .value-amount {
      font-weight: 600;
    }

    .banker-panel {
      background: rgba(10, 10, 10, 0.96);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 10px 10px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .banker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .banker-offer-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-gold);
    }

    .banker-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      white-space: nowrap;
      transition: background 0.18s ease, transform 0.1s ease, box-shadow 0.18s ease;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(to bottom, var(--accent-blue), #0d47a1);
      color: white;
      box-shadow: 0 4px 14px rgba(30, 136, 229, 0.7);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(to bottom, #424242, #111);
      color: var(--text-main);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
    }

    .btn-danger {
      background: linear-gradient(to bottom, #ff5252, #b71c1c);
      color: white;
      box-shadow: 0 4px 14px rgba(255, 82, 82, 0.7);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: none;
    }

    .game-log {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
      max-height: 120px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .log-entry {
      margin-bottom: 2px;
    }

    .log-entry span {
      color: var(--primary-gold);
    }

    .footer-bar {
      margin-top: 2px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="page-wrapper selection-phase" id="pageWrapper">
    <header>
      <h1>Deal or No Deal</h1>
      <p>16 Case Edition &mdash; Choose wisely, play the odds.</p>
    </header>

    <div class="top-bar">
      <div class="status-text" id="statusText">Choose Your Case</div>
      <div class="round-info">
        <span id="roundSpan">Round: 0</span>
        <span id="toOpenSpan">Cases to open: 0</span>
        <span id="remainingSpan">Remaining cases: 16</span>
      </div>
    </div>

    <div class="main-layout">
      <!-- LEFT: CASE GRID -->
      <section class="grid-section">
        <div class="grid-title">Case Selection</div>
        <div class="case-grid" id="caseGrid"></div>
      </section>

      <!-- RIGHT: MAIN CASE + VALUES + BANKER -->
      <section class="sidebar">
        <div class="main-case-wrapper">
          <div class="main-case-label">Your Case</div>
          <div class="main-case-slot" id="mainCaseSlot">
            <div class="no-main-case-placeholder">
              You haven't selected your case yet.<br />
              Tap a case from the grid to lock it in.
            </div>
          </div>
        </div>

        <div class="values-panel" id="valuesPanel">
          <!-- Values filled by JS -->
        </div>

        <div class="banker-panel">
          <div class="banker-header">
            <div>Banker</div>
            <div class="banker-offer-value" id="bankerOfferValue">Waiting...</div>
          </div>
          <div class="banker-buttons">
            <button class="btn-primary" id="openNextBtn">Open next case</button>
            <button class="btn-secondary" id="callBankerBtn">Call banker</button>
            <button class="btn-danger" id="resetGameBtn">Reset</button>
            <button class="btn-ghost" id="goToOfferPageBtn">Offer page</button>
          </div>
          <div class="game-log" id="gameLog"></div>
        </div>
      </section>
    </div>

    <div class="footer-bar">
      Backend: Google Apps Script &mdash; Offers, banker logic, and custom amounts powered by remote calculations.
    </div>
  </div>

  <script>
    // -------------------------
    // CONFIGURATION
    // -------------------------
    const BACKEND_URL =
      "https://script.google.com/macros/s/AKfycby_rINNEXiPenUtCSDjoWAE4fEr_e1Ky5lsa2Bp7WiLVdst_RmW-TEgPaUmtDJwUcJktQ/exec";

    // Example default 16 values (you can override via custom-amounts.html)
    const DEFAULT_AMOUNTS = [
      1, 5, 10, 20,
      50, 75, 100, 200,
      300, 400, 500, 750,
      1000, 5000, 10000, 50000
    ];

    // Rounds configuration: number of cases to open each round
    const ROUND_SCHEDULE = [5, 4, 3, 2, 1]; // total 15

    // Simple audio hooks (user said "use your existing system"; placeholders here)
    const audio = {
      openCase: null,
      bankerCall: null,
      offerReveal: null
    };

    function playAudioSound(key) {
      const s = audio[key];
      if (s) {
        try {
          s.currentTime = 0;
          s.play();
        } catch (e) {
          // ignore autoplay restrictions
        }
      }
    }

    // -------------------------
    // GAME STATE
    // -------------------------
    let amounts = [];
    let shuffledAmounts = [];
    let caseAmountMap = {}; // caseIndex (1-16) -> amount
    let openedCases = new Set();
    let mainCaseIndex = null;

    let currentRoundIndex = 0;
    let casesOpenedInRound = 0;
    let gamePhase = "selection"; // "selection" | "game" | "ended"

    // -------------------------
    // DOM ELEMENTS
    // -------------------------
    const pageWrapper = document.getElementById("pageWrapper");
    const caseGrid = document.getElementById("caseGrid");
    const mainCaseSlot = document.getElementById("mainCaseSlot");
    const valuesPanel = document.getElementById("valuesPanel");

    const statusText = document.getElementById("statusText");
    const roundSpan = document.getElementById("roundSpan");
    const toOpenSpan = document.getElementById("toOpenSpan");
    const remainingSpan = document.getElementById("remainingSpan");
    const bankerOfferValue = document.getElementById("bankerOfferValue");
    const gameLog = document.getElementById("gameLog");

    const openNextBtn = document.getElementById("openNextBtn");
    const callBankerBtn = document.getElementById("callBankerBtn");
    const resetGameBtn = document.getElementById("resetGameBtn");
    const goToOfferPageBtn = document.getElementById("goToOfferPageBtn");

    // -------------------------
    // BACKEND HELPERS
    // -------------------------
    async function fetchCustomAmountsFromBackend() {
      try {
        const res = await fetch(BACKEND_URL + "?mode=getAmounts", {
          method: "GET",
          cache: "no-cache"
        });
        if (!res.ok) throw new Error("HTTP error " + res.status);
        const data = await res.json();
        if (Array.isArray(data) && data.length === 16) {
          return data.map((v) => Number(v));
        }
      } catch (err) {
        console.warn("Could not fetch custom amounts, using defaults:", err);
      }
      return DEFAULT_AMOUNTS.slice();
    }

    async function fetchBankerOffer() {
      const remainingAmounts = amounts.filter((amt, idx) => {
        const caseIndex = idx + 1;
        return !openedCases.has(caseIndex) && caseIndex !== mainCaseIndex;
      });

      const payload = {
        mode: "offer",
        remaining: remainingAmounts,
        mainCaseIndex,
        round: currentRoundIndex + 1
      };

      try {
        playAudioSound("bankerCall");
        bankerOfferValue.textContent = "Calling banker...";

        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const offer = typeof data.offer === "number"
          ? data.offer
          : computeFallbackOffer(remainingAmounts);

        bankerOfferValue.textContent = formatCurrency(offer);
        logEvent("Banker offers " + formatCurrency(offer));
        playAudioSound("offerReveal");
      } catch (err) {
        console.warn("Banker offer failed, using fallback:", err);
        const fallback = computeFallbackOffer(remainingAmounts);
        bankerOfferValue.textContent = formatCurrency(fallback);
        logEvent("Banker offer (fallback) " + formatCurrency(fallback));
      }
    }

    function computeFallbackOffer(remaining) {
      if (!remaining.length) return 0;
      const sum = remaining.reduce((a, b) => a + b, 0);
      // Simple fallback: 70% of mean times a round weight
      const mean = sum / remaining.length;
      const roundWeight = 0.5 + currentRoundIndex * 0.1;
      return Math.round(mean * 0.7 * roundWeight);
    }

    // -------------------------
    // UI HELPERS
    // -------------------------
    function formatCurrency(value) {
      return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 0
      }).format(value);
    }

    function logEvent(text) {
      const entry = document.createElement("div");
      entry.className = "log-entry";
      entry.textContent = text;
      gameLog.appendChild(entry);
      gameLog.scrollTop = gameLog.scrollHeight;
    }

    function buildValuesPanel() {
      valuesPanel.innerHTML = "";
      const sorted = [...amounts].sort((a, b) => a - b);
      sorted.forEach((amt, idx) => {
        const div = document.createElement("div");
        div.className = "value-item " + (idx < sorted.length / 2 ? "low" : "high");
        const label = document.createElement("span");
        label.className = "value-label";
        label.textContent = "Value";
        const val = document.createElement("span");
        val.className = "value-amount";
        val.textContent = formatCurrency(amt);

        div.dataset.amount = amt;

        div.appendChild(label);
        div.appendChild(val);
        valuesPanel.appendChild(div);
      });
    }

    function markValueOpened(amount) {
      const items = valuesPanel.querySelectorAll(".value-item");
      items.forEach((item) => {
        if (!item.classList.contains("opened") && Number(item.dataset.amount) === amount) {
          item.classList.add("opened");
        }
      });
    }

    function updateTopBar() {
      roundSpan.textContent = "Round: " + currentRoundIndex;
      const toOpen =
        gamePhase === "game"
          ? Math.max(ROUND_SCHEDULE[currentRoundIndex] - casesOpenedInRound, 0)
          : 0;
      toOpenSpan.textContent = "Cases to open: " + toOpen;
      const remainingCases = 16 - openedCases.size;
      remainingSpan.textContent = "Remaining cases: " + remainingCases;
    }

    function updatePhaseUI() {
      if (gamePhase === "selection") {
        pageWrapper.classList.add("selection-phase");
        statusText.textContent = "Choose Your Case";
        openNextBtn.disabled = true;
        callBankerBtn.disabled = true;
      } else if (gamePhase === "game") {
        pageWrapper.classList.remove("selection-phase");
        statusText.textContent = "Open cases and watch the board.";
        openNextBtn.disabled = false;
        callBankerBtn.disabled = false;
      } else if (gamePhase === "ended") {
        openNextBtn.disabled = true;
        callBankerBtn.disabled = false;
      }
      updateTopBar();
    }

    function createCaseElement(caseIndex) {
      const div = document.createElement("div");
      div.className = "case";
      div.dataset.index = caseIndex;

      const img = document.createElement("img");
      img.src = "suitcase.png";
      img.alt = "Suitcase " + caseIndex;

      const label = document.createElement("div");
      label.className = "case-number";
      label.textContent = caseIndex;

      div.appendChild(img);
      div.appendChild(label);
      return div;
    }

    function rebuildCaseGrid() {
      caseGrid.innerHTML = "";
      for (let i = 1; i <= 16; i++) {
        if (i === mainCaseIndex) continue; // main case removed from grid
        const caseEl = createCaseElement(i);
        caseEl.addEventListener("click", () => onCaseClick(i, caseEl));
        caseGrid.appendChild(caseEl);
      }
    }

    function setMainCase(caseIndex) {
      mainCaseIndex = caseIndex;
      mainCaseSlot.innerHTML = "";

      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";
      wrapper.style.width = "100%";
      wrapper.style.height = "100%";

      const mainCaseElement = createCaseElement(caseIndex);
      mainCaseElement.classList.add("disabled");
      mainCaseElement.style.cursor = "default";

      const tag = document.createElement("div");
      tag.className = "main-case-number-tag";
      tag.textContent = "#" + caseIndex;

      wrapper.appendChild(mainCaseElement);
      wrapper.appendChild(tag);
      mainCaseSlot.appendChild(wrapper);
    }

    function revealCase(caseIndex, caseEl) {
      if (openedCases.has(caseIndex) || caseIndex === mainCaseIndex) return;

      openedCases.add(caseIndex);
      casesOpenedInRound += 1;

      const amount = caseAmountMap[caseIndex];
      markValueOpened(amount);

      // open visual
      caseEl.classList.add("revealed");
      const img = caseEl.querySelector("img");
      if (img) img.src = "suitcase-open.png";

      logEvent("Case #" + caseIndex + " opened: " + formatCurrency(amount));
      playAudioSound("openCase");

      updateRoundProgress();
    }

    function updateRoundProgress() {
      const totalToOpenThisRound = ROUND_SCHEDULE[currentRoundIndex] || 0;
      if (casesOpenedInRound >= totalToOpenThisRound) {
        // Round complete: force banker call, but let user click button
        statusText.textContent = "Round " + (currentRoundIndex + 1) + " complete. Call the banker.";
        openNextBtn.disabled = true;
        callBankerBtn.disabled = false;
      }
      updateTopBar();
    }

    function onCaseClick(caseIndex, caseEl) {
      if (gamePhase === "selection") {
        // User choosing their main case
        setMainCase(caseIndex);
        rebuildCaseGrid(); // removes selected from grid
        gamePhase = "game";
        currentRoundIndex = 0;
        casesOpenedInRound = 0;
        logEvent("You selected case #" + caseIndex + " as your case.");
        updatePhaseUI();
      } else if (gamePhase === "game") {
        const totalToOpenThisRound = ROUND_SCHEDULE[currentRoundIndex] || 0;
        const remainingToOpen = totalToOpenThisRound - casesOpenedInRound;
        if (remainingToOpen <= 0) {
          statusText.textContent =
            "You’ve opened enough cases this round. Call the banker.";
          openNextBtn.disabled = true;
          return;
        }
        revealCase(caseIndex, caseEl);
      }
    }

    function handleOpenNextClick() {
      if (gamePhase !== "game") return;
      const totalToOpenThisRound = ROUND_SCHEDULE[currentRoundIndex] || 0;
      const remainingToOpen = totalToOpenThisRound - casesOpenedInRound;
      if (remainingToOpen <= 0) {
        statusText.textContent =
          "You’ve opened enough cases this round. Call the banker.";
        openNextBtn.disabled = true;
        return;
      }

      // Let player choose visually; here we just hint in status text
      statusText.textContent = "Tap a case to open (" + remainingToOpen + " left this round).";
    }

    async function handleCallBankerClick() {
      if (gamePhase === "selection") return;

      await fetchBankerOffer();

      // Move to next round if there is one, else the game is effectively in final stage
      const totalToOpenThisRound = ROUND_SCHEDULE[currentRoundIndex] || 0;
      if (casesOpenedInRound >= totalToOpenThisRound && currentRoundIndex < ROUND_SCHEDULE.length - 1) {
        currentRoundIndex += 1;
        casesOpenedInRound = 0;
        statusText.textContent =
          "Offer received. If you say NO DEAL, open " +
          ROUND_SCHEDULE[currentRoundIndex] +
          " more next round.";
        openNextBtn.disabled = false;
      } else if (currentRoundIndex >= ROUND_SCHEDULE.length - 1) {
        statusText.textContent =
          "Final stretch. Few cases left; keep opening or take the deal.";
      }

      updateTopBar();
    }

    function handleResetClick() {
      initGame();
    }

    function handleOfferPageNav() {
      window.location.href = "offer.html";
    }

    // -------------------------
    // GAME INIT
    // -------------------------
    async function initGame() {
      // Reset basic state
      amounts = await fetchCustomAmountsFromBackend();
      shuffledAmounts = [...amounts].sort(() => Math.random() - 0.5);
      caseAmountMap = {};
      openedCases.clear();
      mainCaseIndex = null;
      currentRoundIndex = 0;
      casesOpenedInRound = 0;
      gamePhase = "selection";

      // Map amounts to cases 1–16
      for (let i = 0; i < 16; i++) {
        caseAmountMap[i + 1] = shuffledAmounts[i];
      }

      // Rebuild UI
      caseGrid.innerHTML = "";
      for (let i = 1; i <= 16; i++) {
        const caseEl = createCaseElement(i);
        caseEl.addEventListener("click", () => onCaseClick(i, caseEl));
        caseGrid.appendChild(caseEl);
      }

      mainCaseSlot.innerHTML =
        '<div class="no-main-case-placeholder">You haven\'t selected your case yet.<br />Tap a case from the grid to lock it in.</div>';

      gameLog.innerHTML = "";
      bankerOfferValue.textContent = "Waiting...";
      buildValuesPanel();
      logEvent("New game started. Choose your case.");

      updatePhaseUI();
    }

    // -------------------------
    // EVENT LISTENERS
    // -------------------------
    openNextBtn.addEventListener("click", handleOpenNextClick);
    callBankerBtn.addEventListener("click", handleCallBankerClick);
    resetGameBtn.addEventListener("click", handleResetClick);
    goToOfferPageBtn.addEventListener("click", handleOfferPageNav);

    // -------------------------
    // START
    // -------------------------
    initGame();
  </script>
</body>
</html>
