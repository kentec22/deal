<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal or No Deal - Game</title>
    <style>
        /* ... (all your existing CSS remains exactly the same) ... */
        
        /* Add a new style for the audio permission button */
        .audio-permission {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1005;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: black;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .audio-permission:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    <!-- Audio Permission Button -->
    <button class="audio-permission" id="audioPermissionBtn" onclick="enableAudio()">
        ðŸ”ˆ ENABLE AUDIO
    </button>

    <div class="container">
        <!-- ... (all your existing HTML remains exactly the same) ... -->
    </div>

    <script>
        // Game State
        const gameState = {
            playerName: '',
            playerCase: null,
            selectedCase: null,
            cases: [],
            amounts: [],
            remainingAmounts: [],
            openedCases: [],
            currentLevel: 1,
            casesToOpenThisLevel: 0,
            totalCases: 0,
            bankerOffer: 0,
            gamePhase: 'welcome', // welcome, caseSelect, playing, offer, ended
            settings: null,
            audioController: null,
            caseSize: 140,
            visitorId: null,
            sessionId: null,
            audioEnabled: false
        };

        // Enhanced Audio Controller with user interaction handling
        const audioController = {
            introAudio: null,
            bigCaseAudio: null,
            smallCaseAudio: null,
            audioContext: null,
            
            init: function() {
                this.introAudio = new Audio('1-intro.mp3');
                this.introAudio.loop = true;
                this.introAudio.preload = 'auto';
                
                this.bigCaseAudio = new Audio('6-bigcase.mp3');
                this.bigCaseAudio.preload = 'auto';
                
                this.smallCaseAudio = new Audio('5-smallcase.mp3');
                this.smallCaseAudio.preload = 'auto';
                
                // Set volume levels
                this.introAudio.volume = 0.7;
                this.bigCaseAudio.volume = 0.8;
                this.smallCaseAudio.volume = 0.8;
                
                this.logToFile('debug.txt', 'Audio controller initialized (awaiting user interaction)');
            },
            
            enableAudio: function() {
                gameState.audioEnabled = true;
                this.logToFile('debug.txt', 'Audio enabled by user interaction');
                
                // Try to play intro audio now that we have user interaction
                this.playIntro();
                
                // Hide the audio permission button
                const audioBtn = document.getElementById('audioPermissionBtn');
                if (audioBtn) {
                    audioBtn.style.display = 'none';
                }
            },
            
            playIntro: function() {
                if (!gameState.audioEnabled) {
                    this.logToFile('debug.txt', 'Audio not enabled - waiting for user interaction');
                    return;
                }
                
                if (this.introAudio) {
                    const playPromise = this.introAudio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            this.logToFile('debug.txt', 'Intro audio started playing successfully');
                        }).catch(error => {
                            this.logToFile('debug.txt', `Intro audio play failed: ${error.message}`);
                            // Show audio permission button again if failed
                            this.showAudioPermission();
                        });
                    }
                }
            },
            
            stopIntro: function() {
                if (this.introAudio) {
                    this.introAudio.pause();
                    this.introAudio.currentTime = 0;
                    this.logToFile('debug.txt', 'Intro audio stopped');
                }
            },
            
            playCaseComparison: function(isBigCase) {
                if (!gameState.audioEnabled) {
                    this.logToFile('debug.txt', 'Audio not enabled - cannot play case comparison');
                    return;
                }
                
                let audioToPlay = null;
                let audioName = '';
                
                if (isBigCase && this.bigCaseAudio) {
                    audioToPlay = this.bigCaseAudio;
                    audioName = 'big case';
                } else if (this.smallCaseAudio) {
                    audioToPlay = this.smallCaseAudio;
                    audioName = 'small case';
                }
                
                if (audioToPlay) {
                    // Reset audio to start
                    audioToPlay.currentTime = 0;
                    
                    const playPromise = audioToPlay.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            this.logToFile('debug.txt', `${audioName} audio played successfully`);
                        }).catch(error => {
                            this.logToFile('debug.txt', `${audioName} audio play failed: ${error.message}`);
                        });
                    }
                }
            },
            
            showAudioPermission: function() {
                const audioBtn = document.getElementById('audioPermissionBtn');
                if (audioBtn) {
                    audioBtn.style.display = 'block';
                    gameState.audioEnabled = false;
                }
            },
            
            logToFile: function(filename, message) {
                console.log(`[${new Date().toISOString()}] ${message}`);
                debugLogger.log(message, 'AUDIO');
            }
        };

        // Tracking System (unchanged)
        const trackingSystem = {
            init: function() {
                this.generateVisitorId();
                this.generateSessionId();
                this.trackPageView();
                this.logToFile('tracking.txt', `VISITOR_${gameState.visitorId}_SESSION_${gameState.sessionId}_PAGE_LOADED`);
            },
            
            generateVisitorId: function() {
                let visitorId = localStorage.getItem('dealOrNoDeal_visitorId');
                if (!visitorId) {
                    visitorId = 'VISITOR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('dealOrNoDeal_visitorId', visitorId);
                }
                gameState.visitorId = visitorId;
            },
            
            generateSessionId: function() {
                gameState.sessionId = 'SESSION_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },
            
            trackPageView: function() {
                const data = {
                    visitorId: gameState.visitorId,
                    sessionId: gameState.sessionId,
                    timestamp: new Date().toISOString(),
                    action: 'PAGE_VIEW',
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    language: navigator.language
                };
                this.logToAnalytics(data);
            },
            
            trackGameAction: function(action, details = {}) {
                const data = {
                    visitorId: gameState.visitorId,
                    sessionId: gameState.sessionId,
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: details,
                    gamePhase: gameState.gamePhase,
                    currentLevel: gameState.currentLevel
                };
                this.logToAnalytics(data);
            },
            
            logToAnalytics: function(data) {
                const logEntry = `[${data.timestamp}] ${data.visitorId} - ${data.sessionId} - ${data.action} - ${JSON.stringify(data.details)}\n`;
                console.log('ANALYTICS:', logEntry);
                this.logToFile('tracking.txt', logEntry);
            },
            
            logToFile: function(filename, message) {
                console.log(`[${filename}] ${message}`);
            }
        };

        // Debug Logger (unchanged)
        const debugLogger = {
            log: function(message, level = 'INFO') {
                const timestamp = new Date().toISOString();
                const logMessage = `[${timestamp}] [${level}] ${message}\n`;
                
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    debugInfo.innerHTML += logMessage.replace(/\n/g, '<br>');
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
                
                console.log(`[DEBUG] ${logMessage}`);
                this.writeToDebugFile(logMessage);
            },
            
            error: function(message) {
                this.log(message, 'ERROR');
            },
            
            warn: function(message) {
                this.log(message, 'WARN');
            },
            
            writeToDebugFile: function(message) {
                console.log(`[DEBUG_FILE] ${message}`);
            }
        };

        // Enable Audio Function
        function enableAudio() {
            audioController.enableAudio();
            trackingSystem.trackGameAction('AUDIO_ENABLED');
        }

        // Enhanced initialization with audio permission handling
        function initGame() {
            debugLogger.log('Game initialization started');
            trackingSystem.init();
            audioController.init();
            
            // Show audio permission button initially
            const audioBtn = document.getElementById('audioPermissionBtn');
            if (audioBtn) {
                audioBtn.style.display = 'block';
            }
            
            // Set company logo to same width as game title
            const companyLogo = document.querySelector('.company-logo');
            const gameTitleImg = document.querySelector('.game-title-img');
            if (companyLogo && gameTitleImg) {
                companyLogo.style.maxWidth = '350px';
                companyLogo.style.maxHeight = '80px';
                debugLogger.log('Company logo dimensions set to match game title');
            }
            
            // Load settings and initialize game state
            loadSettings();
            generateAmounts();
            generateCases();
            
            // Set player name with audio interaction opportunity
            setTimeout(() => {
                const playerName = prompt('Enter your name:', 'Player') || 'Player';
                gameState.playerName = playerName;
                document.getElementById('playerNameDisplay').textContent = playerName;
                document.getElementById('welcomePlayerName').textContent = playerName;
                
                debugLogger.log(`Game initialized for player: ${playerName}`);
                trackingSystem.trackGameAction('GAME_INIT', { playerName: playerName });
                
                // After user interaction with prompt, try to enable audio
                if (!gameState.audioEnabled) {
                    debugLogger.log('User interacted with name prompt - attempting to enable audio');
                    enableAudio();
                }
            }, 1000);
        }

        // Enhanced handleDealDecision function with audio check
        function handleDealDecision(acceptDeal) {
            debugLogger.log(`Deal decision: ${acceptDeal ? 'DEAL' : 'NO DEAL'}`);
            trackingSystem.trackGameAction('DEAL_DECISION', { 
                accepted: acceptDeal, 
                bankerOffer: gameState.bankerOffer 
            });
            
            if (acceptDeal) {
                // Compare amounts and play appropriate audio
                const playerCaseAmount = gameState.playerCase ? gameState.playerCase.amount : 0;
                const isBigCase = playerCaseAmount > gameState.bankerOffer;
                
                debugLogger.log(`Case comparison - Player case: ${playerCaseAmount}, Banker offer: ${gameState.bankerOffer}, Result: ${isBigCase ? 'BIG CASE' : 'SMALL CASE'}`);
                
                // Play comparison audio
                audioController.playCaseComparison(isBigCase);
                
                // Log result
                if (isBigCase) {
                    debugLogger.warn('Player took deal but their case was worth MORE than the offer');
                } else {
                    debugLogger.log('Player took deal and their case was worth LESS than the offer');
                }
                
                endGame(acceptDeal);
            } else {
                hideOfferDisplay();
                continueGame();
            }
        }

        // Enhanced start game function to ensure audio is enabled
        function startGame() {
            debugLogger.log('Game started');
            trackingSystem.trackGameAction('GAME_STARTED');
            
            // Ensure audio is enabled when game starts
            if (!gameState.audioEnabled) {
                debugLogger.warn('Starting game without audio enabled');
                audioController.showAudioPermission();
            }
            
            // Your existing start game logic here
            document.getElementById('welcomeSplash').style.display = 'none';
            document.getElementById('caseSelectSplash').style.display = 'flex';
            gameState.gamePhase = 'caseSelect';
        }

        // Add click event listeners to all buttons to capture user interaction
        function setupUserInteractionListeners() {
            const buttons = document.querySelectorAll('button, .case, .btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    if (!gameState.audioEnabled) {
                        debugLogger.log('User interaction detected - enabling audio');
                        enableAudio();
                    }
                });
            });
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            initGame();
            setupUserInteractionListeners();
            debugLogger.log('Page fully loaded with audio interaction listeners');
        });

        // Rest of your existing functions remain the same...
        function createAmountItem(amount, index) {
            const amountItem = document.createElement('div');
            amountItem.className = 'amount-item';
            amountItem.id = `amount-${index}`;
            
            amountItem.innerHTML = `
                <div class="amount-value">${formatAmount(amount)}</div>
            `;
            
            if (amount >= 1000000) {
                amountItem.classList.add('jackpot');
            }
            
            return amountItem;
        }

        function selectCase(caseElement, caseNumber) {
            const caseObj = gameState.cases.find(c => c.number === caseNumber);
            if (!caseObj || caseObj.opened) return;
            
            // Fade the selected case
            caseElement.classList.add('faded');
            caseElement.classList.remove('selectable');
            
            debugLogger.log(`Case ${caseNumber} selected and faded`);
            trackingSystem.trackGameAction('CASE_SELECTED', { caseNumber: caseNumber });
            
            if (gameState.gamePhase === 'caseSelect') {
                gameState.playerCase = caseObj;
                document.getElementById('playerCaseDisplay').textContent = caseNumber;
                hideCaseSelectSplash();
            } else if (gameState.gamePhase === 'playing') {
                openCase(caseObj);
            }
        }

        function loadSettings() {
            gameState.settings = {
                soundEnabled: true,
                animationsEnabled: true,
                autoPlay: true
            };
            debugLogger.log('Game settings loaded');
        }

        function generateAmounts() {
            gameState.amounts = [
                1, 5, 10, 25, 50, 75, 100, 200, 300, 400, 500, 750,
                1000, 5000, 10000, 25000, 50000, 75000, 100000, 200000,
                300000, 400000, 500000, 750000, 1000000, 2500000, 5000000, 10000000
            ];
            gameState.remainingAmounts = [...gameState.amounts];
            debugLogger.log('Game amounts generated');
        }

        function generateCases() {
            gameState.cases = [];
            for (let i = 1; i <= 28; i++) {
                gameState.cases.push({
                    number: i,
                    amount: 0,
                    opened: false
                });
            }
            debugLogger.log('Game cases generated');
        }

        function formatAmount(amount) {
            return `â‚±${amount.toLocaleString()}`;
        }

        function hideCaseSelectSplash() {
            document.getElementById('caseSelectSplash').style.display = 'none';
            gameState.gamePhase = 'playing';
            debugLogger.log('Case selection splash hidden, game phase: playing');
        }

        function hideOfferDisplay() {
            document.getElementById('offerDisplaySplash').style.display = 'none';
            debugLogger.log('Offer display hidden');
        }

        function openCase(caseObj) {
            caseObj.opened = true;
            gameState.openedCases.push(caseObj);
            debugLogger.log(`Case ${caseObj.number} opened`);
            trackingSystem.trackGameAction('CASE_OPENED', { caseNumber: caseObj.number });
        }

        function continueGame() {
            debugLogger.log('Continuing game after NO DEAL');
        }

        function endGame(acceptedDeal) {
            gameState.gamePhase = 'ended';
            debugLogger.log(`Game ended - Deal accepted: ${acceptedDeal}`);
            trackingSystem.trackGameAction('GAME_ENDED', { 
                acceptedDeal: acceptedDeal,
                finalOffer: gameState.bankerOffer 
            });
        }

        // Placeholder functions
        function skipCaseSelection() { debugLogger.log('Case selection skipped'); }
        function hideLevelSplash() { debugLogger.log('Level splash hidden'); }
        function submitOffer() { debugLogger.log('Offer submitted'); }
        function cancelOffer() { debugLogger.log('Offer cancelled'); }
        function closeGameEndSplash() { debugLogger.log('Game end splash closed'); }
        function restartGame() { 
            debugLogger.log('Game restarted');
            trackingSystem.trackGameAction('GAME_RESTARTED');
        }
        function toggleDebug() { 
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            debugLogger.log('Debug panel toggled');
        }
        function openSettings() { debugLogger.log('Settings opened'); }
        function adjustCaseSize(change) { 
            gameState.caseSize += change;
            debugLogger.log(`Case size adjusted: ${change}, new size: ${gameState.caseSize}`);
        }
    </script>
</body>
</html>
