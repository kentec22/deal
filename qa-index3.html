<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Deal or No Deal - Main Board</title>

<style>
    body {
        margin: 0;
        background: black;
        color: white;
        font-family: Arial Black;
        overflow: hidden;
    }

    #pairingBox {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.15);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        font-size: 24px;
    }

    .case {
        width: 160px;
        height: 120px;
        background: url("images/suitcase.png");
        background-size: cover;
        border: 4px solid gold;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 50px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .case:hover {
        transform: scale(1.1);
    }

    .opened {
        background: url("images/suitcase-open.png");
        background-size: cover;
        color: gold;
    }

    #offerPopup {
        position: absolute;
        top: 35%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #222;
        border: 4px solid gold;
        padding: 40px;
        display: none;
        text-align: center;
        font-size: 36px;
        border-radius: 20px;
    }

    #offerAmount {
        font-size: 60px;
        margin-top: 20px;
        color: gold;
    }

    #startGameBtn {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 20px 40px;
        background: gold;
        font-size: 30px;
        border-radius: 10px;
        cursor: pointer;
    }

    #casesToOpen {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 40px;
        color: gold;
    }
</style>
</head>

<body>

<div id="pairingBox">
    <button onclick="createPair()">Generate Pair Code</button><br>
    <span id="pairCode"></span>
</div>

<div id="board"></div>

<div id="offerPopup">
    BANKER OFFER
    <div id="offerAmount"></div>
</div>

<div id="casesToOpen"></div>

<div id="startGameBtn" onclick="startGame()">START GAME</div>

<!-- Audio -->
<audio id="intro" src="audio/intro.mp3" loop></audio>
<audio id="select" src="audio/selecting_case.mp3"></audio>
<audio id="offerSound" src="audio/offer.mp3"></audio>
<audio id="smallReveal" src="audio/case_reveal_small.mp3"></audio>
<audio id="bigReveal" src="audio/case_reveal_big.mp3"></audio>

<script>
let ws = new WebSocket("ws://localhost:8080");
let currentRound = 1;
let roundCases = {1:4, 2:3, 3:2, 4:1, 5:1, 6:1, 7:1, 8:1};
let toOpen = roundCases[currentRound];
let caseValues = [
    0,10,100,250,500,750,
    1000,1500,2000,2500,3000,
    4000,5000,7000,10000
];
let casesOpened = 0;

document.getElementById("casesToOpen").innerText =
    "Cases to Open: " + toOpen;

window.onload = () => {
    intro.play();
    buildBoard();
};

function buildBoard() {
    const board = document.getElementById("board");
    board.style.display = "grid";
    board.style.gridTemplateColumns = "repeat(5, 1fr)";
    board.style.gridGap = "20px";
    board.style.padding = "40px";

    for (let i = 1; i <= 15; i++) {
        let div = document.createElement("div");
        div.className = "case";
        div.innerText = i;
        div.onclick = () => selectCase(i, div);
        board.appendChild(div);
    }
}

function startGame() {
    document.getElementById("startGameBtn").style.display = "none";
    intro.pause();
}

function selectCase(num, el) {
    if (el.classList.contains("opened") || toOpen === 0) return;

    select.play();

    let value = caseValues[num - 1];

    setTimeout(() => {
        el.classList.add("opened");
        if (value <= 1500) smallReveal.play();
        else bigReveal.play();

        toOpen--;
        casesOpened++;
        document.getElementById("casesToOpen").innerText =
            "Cases to Open: " + toOpen;

        if (toOpen === 0) bankerTurn();
    }, 800);
}

function bankerTurn() {
    let offer = calculateOffer();
    ws.send(JSON.stringify({type:"hostCommand", command:"offer", offer}));
    showOffer(offer);

    currentRound++;
    toOpen = roundCases[currentRound] ?? 1;
}

function calculateOffer() {
    let remaining = caseValues.filter((v, i) => {
        let c = document.getElementsByClassName("case")[i];
        return !c.classList.contains("opened");
    });

    let avg = remaining.reduce((a,b)=>a+b)/remaining.length;
    return Math.round(avg * 0.55); // banker deal factor
}

function showOffer(amount) {
    offerSound.play();
    document.getElementById("offerAmount").innerText = "â‚±" + amount.toLocaleString();
    document.getElementById("offerPopup").style.display = "block";
    setTimeout(() => {
        document.getElementById("offerPopup").style.display = "none";
    }, 6000);
}

function createPair() {
    ws.send(JSON.stringify({type:"createPair"}));
}

ws.onmessage = msg => {
    let data = JSON.parse(msg.data);

    if (data.type === "pairCreated") {
        document.getElementById("pairCode").innerText =
            "Code: " + data.code;
    }

    if (data.type === "remoteConnected") {
        document.getElementById("pairCode").innerText += "\nRemote Connected!";
    }

    // remote banker sends new offer
    if (data.type === "remoteCommand" && data.command === "setOffer") {
        showOffer(data.amount);
    }
};
</script>

</body>
</html>
